/***
 * Excerpted from "Secure Your Node.js Web Application",
 * published by The Pragmatic Bookshelf.
 * Copyrights apply to this code. It may not be used to create training material,
 * courses, books, articles, and the like. Contact us if you are in doubt.
 * We make no guarantees that this code is fit for any purpose.
 * Visit http://www.pragmaticprogrammer.com/titles/kdnodesec for more book information.
***/
'use strict';

var mysql = require('mysql');
var express = require('express');
/* modified for c9.io exercise
var args = require('minimist')(process.argv);

if(!args.u || !args.d || !args.p) {
    console.log('This example requires the ' +
    '-u (user), ' +
    '-d (mysql db) and ' +
    '-p (password) command line variables');
    process.exit();
}

var connection = mysql.createConnection({
    host     : 'localhost',
    user     : args.u,
    database : args.d,
    password : args.p,
    multipleStatements: true // This is so we can execute multiple statements
});
*/
var vhost = "localhost";
var vuser = "c9user";
var vdatabase = "c9";
var vpassword = "";
var connection = mysql.createConnection({
    host     : vhost,
    user     : vuser,
    database : vdatabase,
    password : vpassword,
    multipleStatements: true // This is so we can execute multiple statements
});

connection.connect();

var app = express();

app.get('/', function (req, res) {
    res.send('ok');
});

app.get('/:name', function(req, res, next){
    // Validate that the name has only letters
    if(req.params.name.match(/[^a-zA-Z]/)) {
        // It didn't so send a Bad Request response
        res.sendStatus(400);
        return;
    }

    // Query the account based on url parameters
    connection.query('SELECT * FROM accounts WHERE name="' + req.params.name + '"',
        function(err, rows, fields) {
            if (err) {
                next(err);
                return;
            }
            res.send(JSON.stringify(rows));
        });
});

//app.listen(3000);
app.listen(8080, function () {
  console.log('Example app listening on port 8080!')
})
